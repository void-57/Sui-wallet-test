<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Sui Wallet</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/sha256.js"></script>
    <script src="blakejs-custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="lib.sui.js"></script>
    <script src="suiCrypto.js"></script>
    <script src="suiBlockchainAPI.js"></script>

    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background: #fafafa;
      }
      h2 {
        color: #333;
        border-bottom: 2px solid #ddd;
        padding-bottom: 4px;
      }
      input,
      button {
        font-size: 14px;
        margin: 5px 0;
        padding: 6px;
        width: 300px;
      }
      button {
        cursor: pointer;
      }
      .input-group {
        margin-bottom: 10px;
      }
      pre {
        background: #eee;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
      }
      a {
        color: #007bff;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .tx-entry {
        border-bottom: 1px solid #ccc;
        padding: 8px 0;
      }
      .incoming {
        color: green;
      }
      .outgoing {
        color: red;
      }
      .contract-interaction {
        color: #555;
      }
      #pagination {
        margin-top: 10px;
        display: none;
      }
      #pagination button {
        padding: 5px 10px;
        margin: 0 5px;
      }
      #pageInfo {
        font-weight: bold;
      }
      .tx-list {
        background: #fff;
        border-radius: 6px;
        padding: 8px;
        border: 1px solid #e0e0e0;
      }
      .meta {
        white-space: pre-wrap;
        word-break: break-all;
      }
      .empty {
        padding: 20px;
        color: #666;
      }
      .pager {
        margin: 12px 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .tx {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
      }
      .tx:last-child {
        border-bottom: none;
      }
      .digest {
        color: #1a73e8;
        text-decoration: none;
        font-weight: 600;
      }
      .digest:hover {
        text-decoration: underline;
      }
      .sent {
        color: #b71c1c;
        font-weight: 700;
      }
      .received {
        color: #0b6b2e;
        font-weight: 700;
      }
      .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 8px;
        background: #e9f7ef;
        color: #0b6b2e;
        border: 1px solid #d0efdd;
      }
      .badge.out {
        background: #ffecec;
        color: #b71c1c;
        border: 1px solid #ffd6d6;
      }
      .filter-controls {
        margin-bottom: 12px;
      }
      .filter-controls button {
        width: auto;
        background-color: #f0f0f0;
      }
      .filter-controls button.active {
        background-color: #1a73e8;
        color: white;
        border-color: #1a73e8;
        font-weight: bold;
      }
      #sendForm {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        margin-bottom: 15px;
      }
      #sendForm .input-group {
        margin-bottom: 15px;
      }
      #sendForm label {
        font-weight: 600;
        color: #333;
      }
      #sendForm input {
        width: 100%;
        max-width: 500px;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
      }
      #sendForm input:focus {
        outline: none;
        border-color: #1a73e8;
      }
      #sendSuiBtn,
      #estimateGasBtn {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
      }
      #sendSuiBtn:hover,
      #estimateGasBtn:hover {
        background: #1557b0;
      }
      #estimateGasBtn {
        background: #48bb78;
      }
      #estimateGasBtn:hover {
        background: #38a169;
      }
      #senderBalance {
        font-size: 13px;
        color: #1a73e8;
        margin-top: 6px;
        font-weight: 600;
        padding: 6px;
        background: #f0f7ff;
        border-radius: 4px;
        display: none;
      }
      #senderBalance.show {
        display: block;
      }
      #sendOutput {
        background: #f7fafc;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        margin-top: 10px;
      }
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
      }
      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 30px;
        border: none;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s;
      }
      .modal-content h3 {
        color: #333;
        margin-top: 0;
        border-bottom: 2px solid #1a73e8;
        padding-bottom: 10px;
      }
      .modal-content button {
        margin: 10px 5px 0 0;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
      }
      #confirmSend {
        background: #1a73e8;
        color: white;
        border: none;
      }
      #confirmSend:hover {
        background: #1557b0;
      }
      #cancelSend {
        background: #e0e0e0;
        color: #333;
        border: none;
      }
      #cancelSend:hover {
        background: #d0d0d0;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .success-text {
        color: #38a169;
        font-weight: 600;
      }
      .error-text {
        color: #e53e3e;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <h2>Generate or Recover SUI Wallet</h2>
    <input
      id="suiInputKey"
      placeholder="Enter Private Key (optional)"
      size="60"
    />
    <button id="suiGenerateBtn">Generate / Recover</button>
    <pre id="suiOutput"></pre>

    <h2>Check SUI Balance</h2>
    <input
      id="suiAddressInput"
      placeholder="Enter SUI Address (0x...)"
      size="60"
    />
    <button id="suiBalanceBtn">Check Balance</button>
    <pre id="suiBalanceOutput"></pre>

    <h2>Send SUI</h2>
    <div id="sendForm">
      <div class="input-group">
        <label for="suiPrivateKey">Private Key (SUI/FLO/BTC):</label><br />
        <input
          id="suiPrivateKey"
          type="password"
          placeholder="Enter your private key"
          style="width: 100%; max-width: 500px"
        />
        <div id="senderBalance"></div>
      </div>
      <div class="input-group">
        <label for="recipientAddress">Recipient Address:</label><br />
        <input
          id="recipientAddress"
          type="text"
          placeholder="Enter SUI recipient address (0x...)"
          style="width: 100%; max-width: 500px"
        />
      </div>
      <div class="input-group">
        <label for="sendAmount">Amount (SUI):</label><br />
        <input
          id="sendAmount"
          type="number"
          step="0.000000001"
          placeholder="Enter amount to send"
          style="width: 100%; max-width: 500px"
          min="0"
        />
      </div>
      <button id="estimateGasBtn">Estimate Gas</button>
      <button id="sendSuiBtn">Send SUI</button>
    </div>
    <pre id="sendOutput"></pre>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
      <div class="modal-content">
        <h3>‚ö†Ô∏è Confirm Transaction</h3>
        <div id="confirmationDetails"></div>
        <button id="confirmSend">‚úÖ Confirm & Send</button>
        <button id="cancelSend">‚ùå Cancel</button>
      </div>
    </div>

    <h2>Transaction History</h2>
    <div class="controls">
      <input
        id="addrInput"
        type="text"
        placeholder="Enter SUI address to see history (0x...)"
        style="width: 420px"
      />
      <button id="fetchBtn">Get Transactions</button>
      <div id="statusText" style="color: #444; font-size: 14px"></div>
    </div>

    <div class="filter-controls">
      <button id="filterAllBtn" class="active">All</button>
      <button id="filterSentBtn">Sent</button>
      <button id="filterReceivedBtn">Received</button>
    </div>

    <div class="pager" id="pagerTop" style="display: none">
      <button id="prevBtn">Prev</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn">Next</button>
    </div>

    <div class="tx-list" id="txList"></div>

    <div class="pager" id="pagerBottom" style="display: none">
      <button id="prevBtn2">Prev</button>
      <span id="pageInfo2">Page 1</span>
      <button id="nextBtn2">Next</button>
    </div>

    <script>
      let suiWallet = null;
      let preparedTxData = null;
      let cachedWallet = null;
      let cachedBalance = null;

      //  Auto-fetch balance for sender
      document
        .getElementById("suiPrivateKey")
        .addEventListener("blur", async () => {
          const privateKey = document
            .getElementById("suiPrivateKey")
            .value.trim();
          const senderBalanceDiv = document.getElementById("senderBalance");

          if (!privateKey) {
            senderBalanceDiv.textContent = "";
            senderBalanceDiv.classList.remove("show");
            cachedWallet = null;
            cachedBalance = null;
            return;
          }

          senderBalanceDiv.textContent = "üîÑ Fetching balance...";
          senderBalanceDiv.classList.add("show");

          try {
            cachedWallet = await suiCrypto.generateMultiChain(privateKey);
            const senderAddress = cachedWallet.SUI.address;

            if (!senderAddress || !senderAddress.startsWith("0x")) {
              throw new Error("Could not derive a valid SUI address.");
            }

            const balance = await suiBlockchainAPI.getBalance(
              senderAddress,
              "0x2::sui::SUI"
            );
            cachedBalance = (Number(balance) / 1e9).toFixed(9);
            senderBalanceDiv.innerHTML = `
            <strong>Address:</strong> ${senderAddress}<br>
            <strong>Balance:</strong> ${cachedBalance} SUI
          `;
          } catch (error) {
            senderBalanceDiv.textContent = `‚ùå Error: ${error.message}`;
            cachedWallet = null;
            cachedBalance = null;
          }
        });

      // Estimate Gas
      document.getElementById("estimateGasBtn").onclick = async () => {
        const privateKey = document
          .getElementById("suiPrivateKey")
          .value.trim();
        const recipientAddress = document
          .getElementById("recipientAddress")
          .value.trim();
        const amount = document.getElementById("sendAmount").value.trim();
        const sendOutput = document.getElementById("sendOutput");

        if (!privateKey || !recipientAddress || !amount) {
          alert("Please fill all fields.");
          return;
        }

        if (
          !recipientAddress.startsWith("0x") ||
          recipientAddress.length !== 66
        ) {
          alert(
            "Invalid recipient address format. Must be 0x followed by 64 hex characters."
          );
          return;
        }

        if (parseFloat(amount) <= 0) {
          alert("Amount must be greater than 0.");
          return;
        }

        sendOutput.textContent = "üîÑ Estimating gas fee...";

        try {
          // Use cached wallet if available
          if (!cachedWallet) {
            cachedWallet = await suiCrypto.generateMultiChain(privateKey);
            const balance = await suiBlockchainAPI.getBalance(
              cachedWallet.SUI.address,
              "0x2::sui::SUI"
            );
            cachedBalance = (Number(balance) / 1e9).toFixed(9);
          }

          const prepared = await suiBlockchainAPI.prepareSuiTransaction(
            privateKey,
            recipientAddress,
            amount
          );

          const gasFee = (prepared.gasFee / 1e9).toFixed(9);
          const totalCost = (parseFloat(amount) + parseFloat(gasFee)).toFixed(
            9
          );
          const remaining = (
            parseFloat(cachedBalance) - parseFloat(totalCost)
          ).toFixed(9);

          sendOutput.innerHTML = `
<span class="success-text">‚úÖ Gas Estimation Complete</span>

<strong>Transaction Details:</strong>
From: ${prepared.senderAddress}
To: ${recipientAddress}
Amount: ${amount} SUI
Estimated Gas: ${gasFee} SUI
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Cost: ${totalCost} SUI

Current Balance: ${cachedBalance} SUI
Remaining After: ${remaining} SUI
          `;
        } catch (error) {
          console.error("Error estimating gas:", error);
          sendOutput.innerHTML = `<span class="error-text">‚ùå Error: ${error.message}</span>`;
        }
      };

      //  Send SUI 
      document.getElementById("sendSuiBtn").onclick = async () => {
        const privateKey = document
          .getElementById("suiPrivateKey")
          .value.trim();
        const recipientAddress = document
          .getElementById("recipientAddress")
          .value.trim();
        const amount = document.getElementById("sendAmount").value.trim();
        const sendOutput = document.getElementById("sendOutput");

        if (!privateKey || !recipientAddress || !amount) {
          alert("Please fill all fields.");
          return;
        }

        if (
          !recipientAddress.startsWith("0x") ||
          recipientAddress.length !== 66
        ) {
          alert(
            "Invalid recipient address format. Must be 0x followed by 64 hex characters."
          );
          return;
        }

        if (parseFloat(amount) <= 0) {
          alert("Amount must be greater than 0.");
          return;
        }

        sendOutput.textContent = "üîÑ Preparing transaction...";

        try {
          preparedTxData = await suiBlockchainAPI.prepareSuiTransaction(
            privateKey,
            recipientAddress,
            amount
          );

          const gasFee = (preparedTxData.gasFee / 1e9).toFixed(9);
          const totalCost = (parseFloat(amount) + parseFloat(gasFee)).toFixed(
            9
          );

          const confirmationDetails = `
            <p><strong>From:</strong><br>${preparedTxData.senderAddress}</p>
            <p><strong>To:</strong><br>${recipientAddress}</p>
            <p><strong>Amount:</strong> ${amount} SUI</p>
            <p><strong>Estimated Gas Fee:</strong> ~${gasFee} SUI</p>
            <p style="border-top: 2px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
              <strong>Total Cost:</strong> ${totalCost} SUI
            </p>
            <p style="color: #e53e3e; font-size: 13px; margin-top: 10px;">
              ‚ö†Ô∏è Please verify the details carefully before confirming.
            </p>
          `;

          document.getElementById("confirmationDetails").innerHTML =
            confirmationDetails;
          document.getElementById("confirmationModal").style.display = "block";
        } catch (error) {
          console.error("Error preparing transaction:", error);
          sendOutput.innerHTML = `<span class="error-text">‚ùå Error: ${error.message}</span>`;
          preparedTxData = null;
        }
      };

      document.getElementById("cancelSend").onclick = () => {
        document.getElementById("confirmationModal").style.display = "none";
        document.getElementById("sendOutput").textContent =
          "‚ùå Transaction cancelled.";
        preparedTxData = null;
      };

      document.getElementById("confirmSend").onclick = async () => {
        if (!preparedTxData) {
          alert("No transaction prepared. Please try again.");
          return;
        }

        const sendOutput = document.getElementById("sendOutput");
        sendOutput.textContent = "üîÑ Signing and sending transaction...";
        document.getElementById("confirmationModal").style.display = "none";

        try {
          const txResponse = await suiBlockchainAPI.signAndSendSuiTransaction(
            preparedTxData
          );

          if (txResponse.error) {
            throw new Error(txResponse.error.message);
          }

          const digest = txResponse.result?.digest;
          if (digest) {
            sendOutput.innerHTML = `
<span class="success-text">‚úÖ Transaction Sent Successfully!</span>

<strong>Transaction Digest:</strong>
${digest}

<strong>View on Explorer:</strong>
<a href="https://www.oklink.com/sui/tx/${digest}" target="_blank" style="color: #1a73e8;">
 https://www.oklink.com/sui/tx/${digest}
</a>

            `;

            // Clear form
            document.getElementById("suiPrivateKey").value = "";
            document.getElementById("recipientAddress").value = "";
            document.getElementById("sendAmount").value = "";
            document.getElementById("senderBalance").textContent = "";
            document.getElementById("senderBalance").classList.remove("show");

            // Reset cached data
            cachedWallet = null;
            cachedBalance = null;
          } else {
            throw new Error("Transaction failed. No digest returned.");
          }
        } catch (error) {
          console.error("Error sending transaction:", error);
          sendOutput.innerHTML = `<span class="error-text">‚ùå Transaction Failed</span>\n\n${error.message}`;
        } finally {
          preparedTxData = null;
        }
      };

      // Close modal if clicked outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("confirmationModal")) {
          document.getElementById("cancelSend").click();
        }
      };

      //  Generate or Recover Wallet
      document.getElementById("suiGenerateBtn").onclick = async () => {
        const input = document.getElementById("suiInputKey").value.trim();
        const wallet = await suiCrypto.generateMultiChain(input);
        suiWallet = wallet;
        document.getElementById("addrInput").value = wallet.SUI.address;
        document.getElementById("suiAddressInput").value = wallet.SUI.address;
        document.getElementById("suiOutput").textContent = JSON.stringify(
          wallet,
          null,
          2
        );
      };

      //  Check Balance
      document.getElementById("suiBalanceBtn").onclick = async () => {
        const address = document.getElementById("suiAddressInput").value.trim();
        if (!address || !address.startsWith("0x")) {
          alert("Enter valid SUI address.");
          return;
        }
        const balance = await suiBlockchainAPI.getBalance(
          address,
          "0x2::sui::SUI"
        );
        const suiBalance = (Number(balance) / 1e9).toFixed(6);
        document.getElementById(
          "suiBalanceOutput"
        ).textContent = `Balance: ${suiBalance} SUI`;
      };

      // Transaction History
      const PAGE_LIMIT = 10;

      let currentFilter = "all";
      let currentAddress = "";
      let cursorSent = null;
      let cursorReceived = null;
      let prevCursors = [];
      let currentPage = 1;

      const addrInput = document.getElementById("addrInput");
      const fetchBtn = document.getElementById("fetchBtn");
      const txList = document.getElementById("txList");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const prevBtn2 = document.getElementById("prevBtn2");
      const nextBtn2 = document.getElementById("nextBtn2");
      const pagerTop = document.getElementById("pagerTop");
      const pagerBottom = document.getElementById("pagerBottom");
      const pageInfo = document.getElementById("pageInfo");
      const pageInfo2 = document.getElementById("pageInfo2");
      const statusText = document.getElementById("statusText");
      const filterAllBtn = document.getElementById("filterAllBtn");
      const filterSentBtn = document.getElementById("filterSentBtn");
      const filterReceivedBtn = document.getElementById("filterReceivedBtn");

      async function loadTransactions(address) {
        statusText.textContent = "Fetching transactions...";
        txList.innerHTML = "";

        const { txs, hasNextPage, nextCursor } =
          await suiBlockchainAPI.getTransactionHistory(
            address,
            currentFilter,
            PAGE_LIMIT,
            {
              from: cursorSent,
              to: cursorReceived,
            }
          );

        cursorSent = nextCursor.from;
        cursorReceived = nextCursor.to;

        if (!txs.length) {
          txList.innerHTML = '<div class="empty">No transactions found.</div>';
          pagerTop.style.display = "none";
          pagerBottom.style.display = "none";
          statusText.textContent = "";
          return;
        }

        pagerTop.style.display = "flex";
        pagerBottom.style.display = "flex";

        txs.forEach((tx) => {
          const div = document.createElement("div");
          div.className = "tx";
          const dirClass = tx.direction === "Sent" ? "sent" : "received";
          const badgeClass = tx.direction === "Sent" ? "badge out" : "badge";

          div.innerHTML = `
            <div class="${dirClass}">
              ‚óè ${tx.direction}
              <a href="https://www.oklink.com/sui/tx/${
                tx.digest
              }" target="_blank" class="digest">${tx.digest}</a>
              <span class="${badgeClass}">${
            tx.direction === "Sent" ? "Out" : "In"
          }</span>
            </div>
            <div class="meta">From: ${tx.from}</div>
            <div class="meta">To: ${tx.to}</div>
            <div class="meta">Amount: ${tx.amountSui} SUI</div>
            <div class="meta">Date & Time: ${tx.datetime}</div>
          `;
          txList.appendChild(div);
        });

        prevBtn.disabled = prevCursors.length === 0;
        prevBtn2.disabled = prevBtn.disabled;
        nextBtn.disabled = !hasNextPage;
        nextBtn2.disabled = nextBtn.disabled;
        pageInfo.textContent = `Page ${currentPage}`;
        pageInfo2.textContent = `Page ${currentPage}`;
        statusText.textContent = "";
      }

      function setFilter(filter) {
        currentFilter = filter;
        filterAllBtn.classList.toggle("active", filter === "all");
        filterSentBtn.classList.toggle("active", filter === "sent");
        filterReceivedBtn.classList.toggle("active", filter === "received");

        cursorSent = null;
        cursorReceived = null;
        prevCursors = [];
        currentPage = 1;
        if (currentAddress) loadTransactions(currentAddress);
      }

      fetchBtn.onclick = async () => {
        const address = addrInput.value.trim();
        if (!address.startsWith("0x")) {
          alert("Please enter a valid SUI address!");
          return;
        }
        currentAddress = address;
        cursorSent = null;
        cursorReceived = null;
        prevCursors = [];
        currentPage = 1;
        setFilter("received");
        await loadTransactions(address);
      };

      nextBtn.onclick = async () => {
        if (!cursorSent && !cursorReceived) return;
        prevCursors.push({ cursorSent, cursorReceived });
        currentPage++;
        await loadTransactions(currentAddress);
      };
      nextBtn2.onclick = () => nextBtn.click();

      prevBtn.onclick = async () => {
        if (!prevCursors.length) return;
        const prev = prevCursors.pop();
        cursorSent = prev.cursorSent;
        cursorReceived = prev.cursorReceived;
        currentPage--;
        await loadTransactions(currentAddress);
      };
      prevBtn2.onclick = () => prevBtn.click();

      addrInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") fetchBtn.click();
      });

      filterAllBtn.onclick = () => setFilter("all");
      filterSentBtn.onclick = () => setFilter("sent");
      filterReceivedBtn.onclick = () => setFilter("received");
    </script>
  </body>
</html>
